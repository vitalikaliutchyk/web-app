name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, export--4.0-firebase-final ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create config.js from environment variables
      run: |
        # Проверяем наличие секретов
        if [ -z "${{ secrets.FIREBASE_API_KEY }}" ]; then
          echo "⚠️ FIREBASE_API_KEY не найден в секретах"
          echo "Создаем демо-версию config.js"
          cat > config.js << 'DEMO_EOF'
        // Демо-конфигурация Firebase
        window.APP_CONFIG = {
          firebase: {
            apiKey: "DEMO_API_KEY",
            authDomain: "demo-project.firebaseapp.com",
            projectId: "demo-project",
            storageBucket: "demo-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:demo"
          },
          app: {
            name: "Car Repair Tracker (Demo)",
            version: "2.0.0",
            debug: true
          }
        };
        
        // Предупреждение о демо-режиме
        document.addEventListener('DOMContentLoaded', () => {
          const warning = document.createElement('div');
          warning.style.cssText = \`
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff9800;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 10000;
            font-weight: bold;
          \`;
          warning.textContent = '⚠️ Демо-режим. Добавьте GitHub Secrets для полноценной работы.';
          document.body.appendChild(warning);
        });
        DEMO_EOF
        else
          echo "✅ Секреты найдены, создаем config.js с реальными данными"
          cat > config.js << 'REAL_EOF'
        // Конфигурация Firebase из переменных окружения
        window.APP_CONFIG = {
          firebase: {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}"
          },
          app: {
            name: "Car Repair Tracker",
            version: "2.0.0",
            debug: false
          }
        };
        
        console.log('✅ Firebase configuration loaded from GitHub Secrets');
        REAL_EOF
        fi
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
