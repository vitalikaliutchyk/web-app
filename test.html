<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест - Учёт автомобилей</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <h1>Тест - Учёт автомобилей</h1>
        </div>
    </header>

    <div class="container">
        <div class="stats">
            <div class="stat-item">
                <span>Авто сегодня:</span>
                <span id="total-cars">0</span>
            </div>
            <div class="stat-item">
                <span>Часы сегодня:</span>
                <span id="total-hours">0.0</span>
            </div>
        </div>

        <form id="car-form">
            <label>
                Тип идентификатора:
                <select id="identifier-type">
                    <option value="reg">Гос. номер (формат: 1234 AB-1)</option>
                    <option value="vin">VIN (последние 4 символа)</option>
                </select>
            </label>

            <label for="identifier-input">Введите идентификатор:</label>
            <input type="text" id="identifier-input" placeholder="Введите номер или VIN" required>

            <label for="hours">Нормо-часы:</label>
            <input type="number" id="hours" min="0" step="0.1" placeholder="Введите количество норма-часов" required>

            <button type="submit">Добавить запись</button>
        </form>

        <div id="table-container">
            <h2>Список автомобилей</h2>
            
            <!-- Панель поиска и фильтрации -->
            <div class="table-controls">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Поиск по идентификатору..." />
                    <button id="search-btn" class="search-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="filter-controls">
                    <select id="sort-select">
                        <option value="timestamp-desc">Сначала новые</option>
                        <option value="timestamp-asc">Сначала старые</option>
                        <option value="identifier-asc">По номеру (А-Я)</option>
                        <option value="identifier-desc">По номеру (Я-А)</option>
                        <option value="hours-desc">По часам (больше)</option>
                        <option value="hours-asc">По часам (меньше)</option>
                    </select>
                    
                    <select id="date-filter">
                        <option value="all">Все даты</option>
                        <option value="today">Сегодня</option>
                        <option value="week">За неделю</option>
                        <option value="month">За месяц</option>
                    </select>
                </div>
            </div>
            
            <table id="car-table">
                <thead>
                    <tr>
                        <th>Идентификатор</th>
                        <th>Дата</th>
                        <th>Часы</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <!-- Пагинация -->
            <div id="pagination" class="pagination hidden">
                <button id="prev-page" class="pagination-btn">←</button>
                <span id="page-info">Страница 1 из 1</span>
                <button id="next-page" class="pagination-btn">→</button>
            </div>
        </div>
    </div>

    <script>
        // Тестовые данные
        let testData = [
            { id: 1, identifier: '1234 AB-1', date: '10.07.2025', hours: 2.5, timestamp: new Date() },
            { id: 2, identifier: '5678 CD-2', date: '10.07.2025', hours: 1.8, timestamp: new Date() },
            { id: 3, identifier: 'Z9X8', date: '09.07.2025', hours: 3.2, timestamp: new Date(Date.now() - 86400000) }
        ];

        // Элементы
        const elements = {
            carForm: document.getElementById('car-form'),
            identifierInput: document.getElementById('identifier-input'),
            hoursInput: document.getElementById('hours'),
            carTableBody: document.querySelector('#car-table tbody'),
            totalCars: document.getElementById('total-cars'),
            totalHours: document.getElementById('total-hours'),
            searchInput: document.getElementById('search-input'),
            searchBtn: document.getElementById('search-btn'),
            sortSelect: document.getElementById('sort-select'),
            dateFilter: document.getElementById('date-filter'),
            prevPageBtn: document.getElementById('prev-page'),
            nextPageBtn: document.getElementById('next-page'),
            pagination: document.getElementById('pagination'),
            pageInfo: document.getElementById('page-info')
        };

        // Состояние
        const appState = {
            filter: '',
            sortBy: 'timestamp',
            sortOrder: 'desc',
            dateFilter: 'all'
        };

        const PAGINATION_CONFIG = {
            itemsPerPage: 20,
            currentPage: 1,
            totalPages: 1
        };

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            bindEvents();
            renderTable();
            updateStats();
        });

        function bindEvents() {
            elements.carForm.addEventListener('submit', handleFormSubmit);
            elements.identifierInput.addEventListener('input', validateIdentifier);
            elements.hoursInput.addEventListener('input', validateHours);
            elements.searchInput.addEventListener('input', debounce(handleSearch, 300));
            elements.searchBtn.addEventListener('click', handleSearch);
            elements.sortSelect.addEventListener('change', handleSort);
            elements.dateFilter.addEventListener('change', handleDateFilter);
            elements.prevPageBtn.addEventListener('click', () => changePage(-1));
            elements.nextPageBtn.addEventListener('click', () => changePage(1));
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function handleSearch() {
            appState.filter = elements.searchInput.value.toLowerCase();
            PAGINATION_CONFIG.currentPage = 1;
            renderTable();
        }

        function handleSort() {
            const sortValue = elements.sortSelect.value;
            const [field, order] = sortValue.split('-');
            appState.sortBy = field;
            appState.sortOrder = order;
            renderTable();
        }

        function handleDateFilter() {
            appState.dateFilter = elements.dateFilter.value;
            PAGINATION_CONFIG.currentPage = 1;
            renderTable();
        }

        function changePage(direction) {
            const newPage = PAGINATION_CONFIG.currentPage + direction;
            if (newPage >= 1 && newPage <= PAGINATION_CONFIG.totalPages) {
                PAGINATION_CONFIG.currentPage = newPage;
                renderTable();
            }
        }

        function validateIdentifier() {
            const input = elements.identifierInput;
            const value = input.value.trim().toUpperCase();
            const type = document.getElementById('identifier-type').value;
            
            input.value = value;
            
            if (type === 'reg') {
                const regPattern = /^\d{4}\s[A-ZА-Я]{2}-\d{1,2}$/;
                if (regPattern.test(value)) {
                    const letters = value.match(/[A-ZА-Я]{2}/)[0];
                    const validLetters = /^[ABEKMHOPCTYXАВЕКМНОРСТУХ]{2}$/;
                    
                    if (validLetters.test(letters)) {
                        input.setCustomValidity('');
                        input.classList.remove('invalid');
                        input.classList.add('valid');
                    } else {
                        input.setCustomValidity('Недопустимые буквы в номере');
                        input.classList.remove('valid');
                        input.classList.add('invalid');
                    }
                } else {
                    input.setCustomValidity('Формат: 1234 AB-1 или 1234 AB-12');
                    input.classList.remove('valid');
                    input.classList.add('invalid');
                }
            } else if (type === 'vin') {
                if (value.length === 4) {
                    const vinPattern = /^[A-Z0-9]{4}$/;
                    if (vinPattern.test(value)) {
                        input.setCustomValidity('');
                        input.classList.remove('invalid');
                        input.classList.add('valid');
                    } else {
                        input.setCustomValidity('Введите последние 4 символа VIN (буквы и цифры)');
                        input.classList.remove('valid');
                        input.classList.add('invalid');
                    }
                } else if (value.length === 17) {
                    const fullVinPattern = /^[A-Z0-9]{17}$/;
                    if (fullVinPattern.test(value)) {
                        input.value = value.slice(-4);
                        input.setCustomValidity('');
                        input.classList.remove('invalid');
                        input.classList.add('valid');
                    } else {
                        input.setCustomValidity('Полный VIN должен содержать 17 символов (буквы и цифры)');
                        input.classList.remove('valid');
                        input.classList.add('invalid');
                    }
                } else {
                    input.setCustomValidity('Введите последние 4 символа VIN или полный VIN (17 символов)');
                    input.classList.remove('valid');
                    input.classList.add('invalid');
                }
            }
            
            input.reportValidity();
        }

        function validateHours() {
            const hours = parseFloat(elements.hoursInput.value);
            const isValid = !isNaN(hours) && hours >= 0.1 && hours <= 24;
            elements.hoursInput.setCustomValidity(isValid ? '' : 'Диапазон: 0.1-24');
            elements.hoursInput.reportValidity();
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!elements.carForm.checkValidity()) {
                elements.carForm.reportValidity();
                return;
            }

            const identifier = elements.identifierInput.value.trim().toUpperCase();
            const hours = parseFloat(elements.hoursInput.value);
            const date = getCurrentDate();
            const id = Date.now();

            testData.unshift({
                id,
                identifier,
                date,
                hours,
                timestamp: new Date()
            });

            elements.carForm.reset();
            elements.identifierInput.classList.remove('valid', 'invalid');
            renderTable();
            updateStats();
            
            alert('Запись успешно добавлена!');
        }

        function getCurrentDate() {
            const d = new Date();
            return `${d.getDate().toString().padStart(2, '0')}.${(d.getMonth() + 1)
                .toString()
                .padStart(2, '0')}.${d.getFullYear()}`;
        }

        function renderTable() {
            let filteredData = filterData(testData);
            filteredData = sortData(filteredData);
            
            const totalItems = filteredData.length;
            PAGINATION_CONFIG.totalPages = Math.ceil(totalItems / PAGINATION_CONFIG.itemsPerPage);
            
            const startIndex = (PAGINATION_CONFIG.currentPage - 1) * PAGINATION_CONFIG.itemsPerPage;
            const endIndex = startIndex + PAGINATION_CONFIG.itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            elements.carTableBody.innerHTML = '';
            
            paginatedData.forEach(repair => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${repair.identifier}</td>
                    <td>${repair.date}</td>
                    <td>${repair.hours.toFixed(1)}</td>
                    <td>
                        <button class="edit" onclick="editRecord(${repair.id})">✎</button>
                        <button class="delete" onclick="deleteRecord(${repair.id})">🗑</button>
                    </td>
                `;
                elements.carTableBody.appendChild(row);
            });
            
            updatePagination();
        }

        function filterData(data) {
            let filtered = [...data];
            
            if (appState.filter) {
                filtered = filtered.filter(repair => 
                    repair.identifier.toLowerCase().includes(appState.filter)
                );
            }
            
            if (appState.dateFilter && appState.dateFilter !== 'all') {
                const today = new Date();
                const todayStr = getCurrentDate();
                
                filtered = filtered.filter(repair => {
                    switch (appState.dateFilter) {
                        case 'today':
                            return repair.date === todayStr;
                        case 'week':
                            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return isDateInRange(repair.date, weekAgo, today);
                        case 'month':
                            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                            return isDateInRange(repair.date, monthAgo, today);
                        default:
                            return true;
                    }
                });
            }
            
            return filtered;
        }

        function sortData(data) {
            return data.sort((a, b) => {
                let aValue, bValue;
                
                switch (appState.sortBy) {
                    case 'identifier':
                        aValue = a.identifier;
                        bValue = b.identifier;
                        break;
                    case 'hours':
                        aValue = parseFloat(a.hours);
                        bValue = parseFloat(b.hours);
                        break;
                    case 'timestamp':
                    default:
                        aValue = a.timestamp;
                        bValue = b.timestamp;
                        break;
                }
                
                if (appState.sortOrder === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
        }

        function isDateInRange(dateStr, startDate, endDate) {
            const [day, month, year] = dateStr.split('.').map(Number);
            const date = new Date(year, month - 1, day);
            return date >= startDate && date <= endDate;
        }

        function updatePagination() {
            if (PAGINATION_CONFIG.totalPages <= 1) {
                elements.pagination.classList.add('hidden');
                return;
            }
            
            elements.pagination.classList.remove('hidden');
            elements.pageInfo.textContent = `Страница ${PAGINATION_CONFIG.currentPage} из ${PAGINATION_CONFIG.totalPages}`;
            
            elements.prevPageBtn.disabled = PAGINATION_CONFIG.currentPage === 1;
            elements.nextPageBtn.disabled = PAGINATION_CONFIG.currentPage === PAGINATION_CONFIG.totalPages;
        }

        function updateStats() {
            const today = getCurrentDate();
            const todayRepairs = testData.filter(repair => repair.date === today);
            
            const totalCars = todayRepairs.length;
            const totalHours = todayRepairs.reduce((sum, repair) => sum + repair.hours, 0);
            
            elements.totalCars.textContent = totalCars;
            elements.totalHours.textContent = totalHours.toFixed(1);
        }

        function editRecord(id) {
            const record = testData.find(r => r.id === id);
            if (record) {
                const newHours = parseFloat(prompt('Введите новые часы:', record.hours));
                if (!isNaN(newHours) && newHours >= 0.1 && newHours <= 24) {
                    record.hours = newHours;
                    renderTable();
                    updateStats();
                }
            }
        }

        function deleteRecord(id) {
            if (confirm('Удалить эту запись?')) {
                testData = testData.filter(r => r.id !== id);
                renderTable();
                updateStats();
            }
        }
    </script>
</body>
</html> 